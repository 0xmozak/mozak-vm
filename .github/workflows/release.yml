# Adapted from Lighthouse: https://github.com/sigp/lighthouse/blob/stable/.github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - v*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-runner:
    runs-on: ubuntu-latest
    outputs:
      runner-label: ${{ steps.set-runner.outputs.runner-label }}

    steps:
      - name: Set runner
        id: set-runner
        run: |
          runners=$(curl \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.READ_RUNNERS_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -L https://api.github.com/repos/${{ github.repository }}/actions/runners || echo "")
          available=$(echo "$runners" | jq '(.runners // [])[] | select(.status == "online" and .busy == false and .labels[] .name == "self-hosted")')
            echo "$runners"

          if [ -n "$available" ]; then
            echo "available1"
            echo "runner-label=self-hosted" >> $GITHUB_OUTPUT
            exit 0
          fi

          runners=$(curl \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.READ_RUNNERS_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -L https://api.github.com/orgs/${{ github.repository_owner }}/actions/runners || echo "")
          echo "$runners"
          available=$(echo "$runners" | jq '(.runners // [])[] | select(.status == "online" and .busy == false and .labels[] .name == "self-hosted")')
          if [ -n "$available" ]; then
            echo "runner-label=self-hosted" >> $GITHUB_OUTPUT
          else
            echo "runner-label=ubuntu-latest" >> $GITHUB_OUTPUT
          fi

  draft-release:
    name: draft release
    needs: check-runner
    runs-on: ${{ needs.check-runner.outputs.runner-label }}
    permissions:
      # Required to post the release
      contents: write
    steps:
      # This is necessary for generating the changelog. 
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Extract version
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" | tee --append "$GITHUB_ENV"
      # ==============================
      #       Create release draft
      # ==============================
      - name: Generate full changelog
        run: |
          tee --append "$GITHUB_ENV" << ENDBODY
          CHANGELOG<<EOF
          $(git log --pretty=tformat:"- %s" $(git describe --tags --abbrev=0 ${TAG_NAME}^)..${TAG_NAME})
          EOF
          ENDBODY

      - name: Create Release Draft
        env:
          GITHUB_USER: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # The formatting here is borrowed from OpenEthereum: https://github.com/openethereum/openethereum/blob/main/.github/workflows/build.yml
        run: |
          gh release create --verify-tag --draft --notes-file - "$TAG_NAME" << ENDBODY
          <Release Name, Version and Time>

          ## Summary

          Add a summary.

          ## All Changes

          ${CHANGELOG}
          ENDBODY
