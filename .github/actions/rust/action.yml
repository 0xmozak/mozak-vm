name: Install rust toolchain

inputs:
  cache-key:
    required: false

runs:
  using: "composite"
  steps:
    - id: get-info
      name: Get info
      shell: bash
      run: |
        RUST_VERSION="$(cat rust-toolchain.toml | grep '^channel\s*=' | cut -d '=' -f2 | sed 's/"//g' | sed -e 's/^[ \t]*//')"
        echo "rust-version=${RUST_VERSION}" >> "$GITHUB_OUTPUT"
        echo "cache-primary-key=toolchain-${{ runner.os }}-${{ runner.arch }}-${RUST_VERSION}" >> "$GITHUB_OUTPUT"

    - id: local-cache-restore
      name: Cache Rust toolchain (Local Restore)
      uses: Daniel-Aaron-Bloom/local-cache/restore@ff33c7264117faa1bbd99aa0ddb467a9ccc3919e
      with:
        key: ${{ steps.get-info.outputs.cache-primary-key }}
        path: |
          ~/.rustup
          ~/.cargo

    - id: remote-cache-restore
      name: Cache Rust toolchain (Remote Restore)
      if: ${{ steps.local-cache-restore.outputs.cache-hit != 'true' }}
      uses: actions/cache/restore@v3
      with:
        key: toolchain-${{ runner.os }}-${{ runner.arch }}-${{ steps.get-info.outputs.rust-version }}
        path: |
          ~/.rustup
          ~/.cargo

    - name: Restore Path
      if: ${{ steps.local-cache-restore.outputs.cache-hit || steps.remote-cache-restore.outputs.cache-hit }}
      shell: bash
      run: echo "${HOME}/.cargo/bin" >> $GITHUB_PATH

    - name: Install toolchain
      if: ${{ steps.local-cache-restore.outputs.cache-hit != 'true' && steps.remote-cache-restore.outputs.cache-hit != 'true' }}
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ steps.get-info.outputs.rust-version }}
        components: rustfmt, clippy

    - name: Install nextest
      if: ${{ steps.local-cache-restore.outputs.cache-hit != 'true' && steps.remote-cache-restore.outputs.cache-hit != 'true' }}
      uses: taiki-e/install-action@nextest

    - id: local-cache-save
      name: Cache Rust toolchain (Local Save)
      if: ${{ steps.local-cache-restore.outputs.cache-hit != 'true' }}
      uses: Daniel-Aaron-Bloom/local-cache/save@ff33c7264117faa1bbd99aa0ddb467a9ccc3919e
      with:
        key: ${{ steps.get-info.outputs.cache-primary-key }}
        path: |
          ~/.rustup
          ~/.cargo

    - id: remote-cache-save
      name: Cache Rust toolchain (Save)
      if: ${{ steps.remote-cache-restore.outputs.cache-hit != 'true' }}
      uses: actions/cache/save@v3
      with:
        key: ${{ steps.get-info.outputs.cache-primary-key }}
        path: |
          ~/.rustup
          ~/.cargo

    - id: local-cache
      name: Cache Rust artifacts (Local)
      uses: Daniel-Aaron-Bloom/rust-cache@c9b47d20f239e19b58698b438f2343e944c7f404
      with:
        prefix-key: ${{ inputs.cache-key == '' && inputs.cache-key || null }}
        cache-provider: "local"

    - name: Cache Rust artifacts (Remote)
      uses: Daniel-Aaron-Bloom/rust-cache@c9b47d20f239e19b58698b438f2343e944c7f404
      if: ${{ steps.local-cache.outputs.cache-hit != 'true'}}
      with:
        prefix-key: ${{ inputs.cache-key == '' && inputs.cache-key || null }}
